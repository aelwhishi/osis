{% extends 'education_group/layout_detail.html' %}
{% load education_group format %}
{% comment "License" %}
* OSIS stands for Open Student Information System. It's an application
* designed to manage the core business of higher education institutions,
* such as universities, faculties, institutes and professional schools.
* The core business involves the administration of students, teachers,
* courses, programs and so on.
*
* Copyright (C) 2015-2018 Universit√© catholique de Louvain (http://www.uclouvain.be)
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU General Public License for more details.
*
* A copy of this license - GNU General Public License - is available
* at the root of the source code of this program.  If not,
* see http://www.gnu.org/licenses/.
{% endcomment %}
{% load bootstrap3 %}
{% load i18n %}
{% load staticfiles %}
{% load admission_conditions %}

{% block content %}
    <div class="panel panel-default">
        <div class="panel-heading">
            <div class="row">
                {% include "education_group/blocks/hamburger_button.html" %}
            </div>
        </div>
        <div class="panel-body" id="tabs">
            <div class="tab-content" id="tab_content">
                <div role="tabpanel" class="tab-pane active" id="admission_conditions">
                    <div class="row" style="display:flex;">
                        {% include "education_group/training_tree.html" %}
                        <div id="panel-data" class="col-md-12" style="height: 100%;">
                            {% include "education_group/tabs.html" %}
                            <br/>

                            <div class="row">
                                {% if info.is_common %}
                                    {% render_condition_text 'alert_message' _('Alert Message') admission_condition.text_alert_message can_edit_information %}
                                {% endif %}

                                {% if info.is_common and info.is_bachelor %}
                                    {% render_condition_text 'ca_bacs_cond_generales' _('General Conditions') admission_condition.text_ca_bacs_cond_generales can_edit_information %}
                                    {% render_condition_text 'ca_bacs_cond_particulieres' _('Specific Conditions') admission_condition.text_ca_bacs_cond_particulieres can_edit_information %}
                                    {% render_condition_text 'ca_bacs_examen_langue' _('Language Exam') admission_condition.text_ca_bacs_examen_langue can_edit_information %}
                                    {% render_condition_text 'ca_bacs_cond_speciales' _('Special Conditions') admission_condition.text_ca_bacs_cond_speciales can_edit_information %}
                                {% endif %}

                                {% if info.is_master and info.show_free_text %}
                                    {% render_condition_text 'free' _('Free Text') admission_condition.text_free can_edit_information %}
                                {% endif %}

                                {% if info.show_components_for_agreg_and_mc %}
                                    {% render_condition_text 'ca_cond_generales' _('General Condition') admission_condition.text_ca_cond_generales can_edit_information %}
                                    {% render_condition_text 'ca_maitrise_fr' _('French language proficiency examination') admission_condition.text_ca_maitrise can_edit_information %}
                                    {% render_condition_text 'ca_allegement' _('Reduction') admission_condition.text_ca_allegement can_edit_information %}
                                    {% render_condition_text 'ca_ouv_adultes' _('Opening to Adults') admission_condition.text_ca_ouv_adultes can_edit_information %}

                                {% endif %}
                                {% if info.is_specific and info.is_master %}
                                    <div id="university_bachelors">
                                        {% render_condition_text 'university_bachelors' _('University Bachelors') admission_condition.text_university_bachelors can_edit_information %}

                                        <table class="table table-bordered">
                                            <thead>
                                            <tr>
                                                <th width="30%">{% trans 'Diploma' %}</th>
                                                <th width="20%">{% trans 'Conditions' %}</th>
                                                <th width="150px">{% trans 'Access' %}</th>
                                                <th>{% trans 'Remarks' %}</th>
                                                {% if can_edit_information %}<th width="10%">{% trans 'Actions' %}</th>{% endif %}
                                            </tr>
                                            </thead>
                                            <tbody>
                                            {% render_condition_rows root education_group_year 'ucl_bachelors' _('UCL Bachelors') record.ucl_bachelors can_edit_information %}
                                            {% render_condition_rows root education_group_year 'others_bachelors_french' _('Others Bachelors of the French speaking Community of Belgium') record.others_bachelors_french can_edit_information %}
                                            {% render_condition_rows root education_group_year 'bachelors_dutch' _('Bachelors of the Dutch speaking Community of Beligum') record.bachelors_dutch can_edit_information %}
                                            {% render_condition_rows root education_group_year 'foreign_bachelors' _('Foreign Bachelors') record.foreign_bachelors can_edit_information %}
                                            </tbody>
                                        </table>
                                        <hr/>
                                    </div>
                                {% endif %}
                                {% if info.is_master %}
                                    {% render_condition_text 'non_university_bachelors' _('Non university Bachelors') admission_condition.text_non_university_bachelors can_edit_information %}
                                {% endif %}
                                {% if info.is_specific and info.is_master %}
                                    <div id="holders_second_university_degree">
                                        <h3>{% trans 'Holders of a 2nd cycle University degree' %}</h3>
                                        <table class="table table-bordered">
                                            <thead>
                                            <tr>
                                                <th width="30%">{% trans 'Diploma' %}</th>
                                                <th width="20%">{% trans 'Conditions' %}</th>
                                                <th width="150px">{% trans 'Access' %}</th>
                                                <th>{% trans 'Remarks' %}</th>
                                                {% if can_edit_information %}<th width="10%">{% trans 'Actions' %}</th>{% endif %}
                                            </tr>
                                            </thead>
                                            <tbody>
                                            {% render_condition_rows root education_group_year 'graduates' _('Graduates') record.graduates can_edit_information %}
                                            {% render_condition_rows root education_group_year 'masters' _('Masters') record.masters can_edit_information %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% render_condition_text 'holders_non_university_second_degree' _('Holders of a non-University 2nd cycle degree') admission_condition.text_holders_non_university_second_degree can_edit_information %}
                                {% endif %}
                                {% if info.is_master %}
                                    {% render_condition_text 'adults_taking_up_university_training' _('Adults taking up their university training') admission_condition.text_adults_taking_up_university_training can_edit_information %}
                                    {% render_condition_text 'personalized_access' _('Personalized access') admission_condition.text_personalized_access can_edit_information %}
                                    {% render_condition_text 'admission_enrollment_procedures' _('Admission and Enrolment Procedures for general registration') admission_condition.text_admission_enrollment_procedures can_edit_information %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if can_edit_information %}
    <div class="modal fade" id="modify_text">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{% trans 'Modify text' %}</h5>
                </div>
                <div class="modal-body">
                    {{ admission_condition_form.text_field }}
                </div>
                <div class="modal-footer">
                    <button id="modify_text_btn" type="submit" class="btn btn-primary" role="button"
                            title="{% trans 'save' %}">{% trans 'save' %}</button>
                    <button type="submit" class="btn" data-dismiss="modal">{% trans 'cancel' %}</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="save_term" role="dialog" data-backdrop="static"></div>
    {% endif %}

{% endblock %}

{% block script %}
    {% if can_edit_information %}
    <script>
        $('a.line-edit-btn').click(function (evt) {
            evt.preventDefault();
            var url = $(this).data('form');
            var modal = $('#save_term');
            modal.load(url, function() {
               $(this).modal('show');
            });
            return false;
        });

        $('#modify_text_btn').click(function(evt) {
            evt.preventDefault();
            var modal = $("#modify_text");
            var url = "{% url 'education_group_year_admission_condition_modify_text' root.pk education_group_year.pk %}";
            var section = $(this).data('section'),
                language = $(this).data('language');

            console.log('modify_text_btn.click', section);

            var text_ptr = CKEDITOR.instances['id_text_field'];

            var data = {
                section: section,
                text: text_ptr.getData(),
                language: language,
            };

            $.ajax(url, {
                data: JSON.stringify(data),
                type: 'post',
                dataType: 'json',
                success: function (response) {
                    if (language === 'fr') {
                        $("#text_" + section).html(response.text);
                    }
                    modal.modal('hide');
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    if (jqXHR.status == 404) {
                        alert(gettext("We can't read the text because it does not exist on the server"));
                    } else if (jqXHR.status == 500) {
                        alert(gettext("There is an error on the server, please contact the OSIS team."));
                    }
                }
            });
        });

        $('.modify-text-btn').click(function (evt) {
            evt.preventDefault();
            var section = $(this).data('section'),
                language = $(this).data('language');
            var url = "{% url 'education_group_year_admission_condition_get_text' root.pk education_group_year.pk %}";

            var modal = $("#modify_text");
            var button = modal.find('#modify_text_btn');
            button.data('section', section);
            button.data('language', language);

            var text_ptr = CKEDITOR.instances['id_text_field'];
            var data = {
                section: section,
                language: language,
            };

            $.ajax(url, {
                data: JSON.stringify(data),
                type: 'post',
                dataType: 'json',
                success: function (data) {
                    text_ptr.setData(data.text);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    if (jqXHR.status == 404) {
                        alert(gettext("We can't modify the text because it does not exist on the server"));
                    } else if (jqXHR.status == 500) {
                        alert(gettext("There is an error on the server, please contact the OSIS team."));
                    }
                }
            });

            modal.modal('show');
            return false;
        });
    </script>
    {% endif %}
{% endblock %}
